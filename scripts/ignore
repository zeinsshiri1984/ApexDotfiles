# ä¼˜å…ˆç”¨å·²å­˜åœ¨çš„ GITHUB_TOKENï¼Œé¿å…åœ¨éäº¤äº’ç¯å¢ƒä¸‹å¡æ­»
if [ -z "${GITHUB_TOKEN:-}" ]; then
    if ! mise exec gh auth status &>/dev/null; then
       if [ -t 0 ]; then
           echo "ğŸ”‘ GitHub Auth Required for Dotfiles."
           mise exec gh -- gh auth login -p ssh -w
           mise exec gh -- gh auth setup-git # Configure git to use gh as credential helper
       else
           echo "âŒ Non-interactive shell detected. Cannot authenticate GitHub."
       fi
    else
       echo "GitHub authenticated."
    fi
fi

# miseä¼šè¯»å–GITHUB_TOKENçªç ´åŒ¿åç”¨æˆ·60æ¬¡/mçš„é™åˆ¶
if mise exec gh -- gh auth status &>/dev/null; then
    export GITHUB_TOKEN=$(mise exec gh -- gh auth token)
fi

# Toolchain Bootstrap (Just, Chezmoi, GH)
echo "ğŸ“¦ Bootstrapping core tools via Mise..."
mise use -g -y -q  uv@latest just@latest usage@latest node@lts

echo "ğŸ³ Configuring Container Engine..."

# Devbox Installation (Requires Nix)
if ! command -v nix &> /dev/null && [ "$IS_IMMUTABLE" -eq 0 ]; then
    echo "â„ï¸ Installing Nix (Determinate Systems)..."
    curl -L https://install.determinate.systems/nix | sh -s -- install --no-confirm

    # åˆ·æ–°ç¯å¢ƒå˜é‡ï¼ˆæ ¹æ®å®‰è£…å™¨æç¤ºï¼Œå¯èƒ½éœ€è¦é‡æ–°å¼€å¯ç»ˆç«¯æˆ– sourceï¼‰
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
fi

if ! command -v devbox &> /dev/null; then
    echo "ğŸ“¦ Installing Devbox..."
    if [ "$IS_IMMUTABLE" -eq 1 ]; then
        # Immutable OS: å¼ºåˆ¶å®‰è£…åˆ°ç”¨æˆ·ç›®å½•ï¼Œæ— éœ€ sudo
        curl -fsSL https://get.jetify.com/devbox | FORCE=1 INSTALL_DIR="$HOME/.local/bin" bash
    else
        # Standard OS: æ ‡å‡†å®‰è£… (å¯èƒ½è§¦å‘ sudo)
        curl -fsSL https://get.jetify.com/devbox | bash
    fi
fi