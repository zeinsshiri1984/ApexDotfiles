#!/bin/bash
set -e # é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢

echo "ğŸ“¦ [1/4] æ£€æŸ¥/æ›´æ–° Devbox..."
if ! command -v devbox &> /dev/null; then
    curl -fsSL https://get.jetify.com/devbox | bash
else
    devbox version update >/dev/null 2>&1 || true
fi

echo "ğŸ“¦ [2/4] æ£€æŸ¥ ai CLI..."
if ! command -v claude &> /dev/null; then
    curl -fsSL https://claude.ai/install.sh | bash
else
    timeout 10s claude update || true 
fi

if ! command -v codex &> /dev/null; then
    npm install -g @openai/codex
else
    timeout 10s npm update -g @openai/codex || true 
fi

ROOT_MOUNT_OPTS="$(findmnt -no OPTIONS / 2>/dev/null || true)"
ROOT_IS_RO="false"
if echo "$ROOT_MOUNT_OPTS" | grep -qE '(^|,)ro(,|$)'; then
    ROOT_IS_RO="true"
fi

echo "ğŸ“¦ [3/4] é…ç½® Podman Socket & Docker Shim..."
mkdir -p "$HOME/.local/bin"

#  Docker Shim (äºŒè¿›åˆ¶åŠ«æŒï¼Œè§£å†³è®¸å¤šå·¥å…·è„šæœ¬ è°ƒç”¨ docker çš„é—®é¢˜)
DOCKER_SHIM="$HOME/.local/bin/docker"
if [ ! -f "$DOCKER_SHIM" ]; then
    cat << 'EOF' > "$DOCKER_SHIM"
#!/bin/sh
exec podman "$@"
EOF
    chmod +x "$DOCKER_SHIM"
    echo "   -> Shim åˆ›å»ºæˆåŠŸ"
fi

#  Systemd Socket (ç”¨æˆ·çº§)
if command -v systemctl &>/dev/null; then
    mkdir -p "$HOME/.config/systemd/user"

    # å¯ç”¨å¹¶ç«‹å³å¯åŠ¨ Socket
    systemctl --user enable --now podman.socket
    
    # æ£€æŸ¥ Socket æ–‡ä»¶
    if [ -S "$XDG_RUNTIME_DIR/podman/podman.sock" ]; then
        echo "âœ… Podman Socket å·²å°±ç»ª: $XDG_RUNTIME_DIR/podman/podman.sock"
    else
        echo "âš ï¸  Podman Socket å¯åŠ¨ä¼¼ä¹å»¶è¿Ÿäº†ï¼Œè¯·ç¨åæ£€æŸ¥ã€‚"
    fi

    # è®¾ç½® Docker Host ä¾›å½“å‰è„šæœ¬åç»­ä½¿ç”¨ (æŒä¹…åŒ–é…ç½®åœ¨ .zshenv)
    export DOCKER_HOST="unix://$XDG_RUNTIME_DIR/podman/podman.sock"
    export TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE="${XDG_RUNTIME_DIR}/podman/podman.sock"
fi

echo "ğŸ“¦ [4/4] é»˜è®¤ Shell è®¾ç½® ..."
TARGET_SHELL="$(which bash)"
if [ "$ROOT_IS_RO" = "true" ]; then
    echo "âš ï¸  æ£€æµ‹åˆ°åªè¯»æ ¹åˆ†åŒºï¼Œè·³è¿‡ç³»ç»Ÿçº§ shell ä¸ sysctl ä¿®æ”¹"
else
    if [ "$SHELL" != "$TARGET_SHELL" ]; then
        grep -q "$TARGET_SHELL" /etc/shells || echo "$TARGET_SHELL" | sudo tee -a /etc/shells >/dev/null
        sudo chsh -s "$TARGET_SHELL" "$USER"
    fi

    echo "ğŸ“¦ æå‡æ–‡ä»¶ç›‘å¬ä¸Šé™  ..."
    if [ -w /proc/sys/fs/inotify/max_user_watches ]; then
        echo 524288 | sudo tee /proc/sys/fs/inotify/max_user_watches >/dev/null
    fi
fi

echo "âœ… ç”¨æˆ·ç¯å¢ƒå°±ç»ªï¼"
