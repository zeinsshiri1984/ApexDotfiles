#!/bin/bash
set -e # é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢

echo "ğŸ“¦ [1/4] æ£€æŸ¥/æ›´æ–° Devbox..."
# æ£€æŸ¥å¹¶å®‰è£… Devbox (Jetify)
if ! command -v devbox &> /dev/null; then
    if [ "$WSL_FLAG" -eq 0 ]; then
        curl -fsSL https://get.jetify.com/devbox | bash
    else
        echo "âš ï¸  WSL ç¯å¢ƒä¸æ”¯æŒ Devboxï¼Œè·³è¿‡å®‰è£…ã€‚"
    fi
else
    devbox version update >/dev/null 2>&1 || true
fi

ROOT_MOUNT_OPTS="$(findmnt -no OPTIONS / 2>/dev/null || true)"
ROOT_IS_RO="false"
if echo "$ROOT_MOUNT_OPTS" | grep -qE '(^|,)ro(,|$)'; then
    ROOT_IS_RO="true"
fi

echo "ğŸ“¦ [3/4] é…ç½® Podman Socket & Docker Shim..."
mkdir -p "$HOME/.local/bin"

#  Docker Shim (äºŒè¿›åˆ¶åŠ«æŒï¼Œè§£å†³è®¸å¤šå·¥å…·è„šæœ¬ è°ƒç”¨ docker çš„é—®é¢˜)
DOCKER_SHIM="$HOME/.local/bin/docker"
if [ ! -f "$DOCKER_SHIM" ]; then
    cat << 'EOF' > "$DOCKER_SHIM"
#!/bin/sh
exec podman "$@"
EOF
    chmod +x "$DOCKER_SHIM"
    echo "   -> Shim åˆ›å»ºæˆåŠŸ"
fi

#  Systemd Socket (ç”¨æˆ·çº§)
if command -v systemctl &>/dev/null && systemctl --user list-units &>/dev/null; then
    mkdir -p "$HOME/.config/systemd/user"

    # å¯ç”¨å¹¶ç«‹å³å¯åŠ¨ Socket
    systemctl --user enable --now podman.socket || echo "âš ï¸  Systemd socket enable failed (ignorable on some systems)"
    
    # æ£€æŸ¥ Socket æ–‡ä»¶
    if [ -S "$XDG_RUNTIME_DIR/podman/podman.sock" ]; then
        echo "âœ… Podman Socket å·²å°±ç»ª: $XDG_RUNTIME_DIR/podman/podman.sock"
    else
        echo "âš ï¸  Podman Socket å¯åŠ¨ä¼¼ä¹å»¶è¿Ÿäº†ï¼Œè¯·ç¨åæ£€æŸ¥ã€‚"
    fi
else
    echo "âš ï¸  Systemd ä¸å¯ç”¨æˆ–æ— æƒé™ï¼Œè·³è¿‡ Podman Socket è‡ªåŠ¨æ¿€æ´»ã€‚"
fi

# è®¾ç½® Docker Host ä¾›å½“å‰è„šæœ¬åç»­ä½¿ç”¨ (æŒä¹…åŒ–é…ç½®åœ¨ .profile/.zshenv)
export DOCKER_HOST="unix://$XDG_RUNTIME_DIR/podman/podman.sock"
export TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE="${XDG_RUNTIME_DIR}/podman/podman.sock"

echo "ğŸ“¦ [4/4] é»˜è®¤ Shell è®¾ç½® ..."
echo "   -> é‡‡ç”¨ Bash -> Exec Nu ç­–ç•¥ï¼Œè·³è¿‡ chsh ä¿®æ”¹ã€‚"

echo "ğŸ“¦ æå‡æ–‡ä»¶ç›‘å¬ä¸Šé™  ..."
    if [ -w /proc/sys/fs/inotify/max_user_watches ]; then
        echo 524288 | sudo tee /proc/sys/fs/inotify/max_user_watches >/dev/null
    fi
fi

echo "âœ… ç”¨æˆ·ç¯å¢ƒå°±ç»ªï¼"
