#!/bin/bash
set -euo pipefail

echo "‚öôÔ∏è  [System Config] Running idempotent setup..."

# 1. Devbox Check
if command -v devbox &>/dev/null; then
  devbox version update >/dev/null 2>&1 || true
fi

# 2. Podman & Docker Shim Setup
mkdir -p "$HOME/.local/bin"
DOCKER_SHIM="$HOME/.local/bin/docker"

# ‰ªÖÂΩìÁúüÊ≠£ÁöÑ docker ‰∏çÂú® path ‰∏≠ÔºåÊàñËÄÖÊàë‰ª¨ÊÉ≥Âº∫Âà∂Âä´ÊåÅÊó∂
if [ ! -f "$DOCKER_SHIM" ] && ! command -v docker &>/dev/null; then
  echo "üê≥ Creating Podman wrapper for Docker CLI..."
  cat << 'EOF' > "$DOCKER_SHIM"
#!/bin/sh
exec podman "$@"
EOF
  chmod +x "$DOCKER_SHIM"
fi

# 3. Systemd Socket (User Level)
# ‰ªÖÂú®ÈùûÂÆπÂô®ÂåñÁéØÂ¢É‰∏î Systemd ÂèØÁî®Êó∂Â∞ùËØï
if command -v systemctl &>/dev/null && [ ! -f /run/.containerenv ]; then
    if systemctl --user list-units --full --all &>/dev/null; then
        echo "üîå Ensuring Podman socket is active..."
        systemctl --user enable --now podman.socket 2>/dev/null || true
    fi
fi

# 4. Flatpak Apps (GUI Only) - Phase 2 Requirement
# [ADDED] ‰ªÖÂú®Êúâ Flatpak ÁöÑÁéØÂ¢É‰∏ãÊâßË°å (Bluefin/PopOS)
if command -v flatpak &>/dev/null; then
    echo "üì¶ Installing GUI Apps via Flatpak..."
    # Á°Æ‰øù Flathub Â≠òÂú®
    flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo --user
    
    # Âü∫Á°Ä GUI Â∑•ÂÖ∑ÈõÜ (ÊåâÈúÄÊ∑ªÂä†)
    # flatpak install -y --noninteractive --user flathub com.mitchellh.ghostty || true
fi

# 4. Kernel Tuning (Notify Only for Immutable/No-Sudo)
# Â∞ùËØïÊèêÂçá file watchesÔºåÂ§±Ë¥•ÂàôÈùôÈªòÊàñË≠¶ÂëäÔºå‰∏çÈòªÂ°û
if [ -w /proc/sys/fs/inotify/max_user_watches ]; then
    CURRENT_LIMIT=$(cat /proc/sys/fs/inotify/max_user_watches)
    if [ "$CURRENT_LIMIT" -lt 524288 ]; then
        if command -v sudo &>/dev/null && sudo -n true 2>/dev/null; then
            echo 524288 | sudo tee /proc/sys/fs/inotify/max_user_watches >/dev/null
            echo "‚úÖ Increased file watch limit."
        else
            echo "‚ö†Ô∏è  File watch limit is low ($CURRENT_LIMIT). Run this manually if tools fail:"
            echo "   echo 524288 | sudo tee /proc/sys/fs/inotify/max_user_watches"
        fi
    fi
fi