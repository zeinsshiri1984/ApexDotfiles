#!/bin/bash
# Brewfile hash: {{ include "Brewfile" | sha256sum }}

set -e # é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢

echo "ğŸ“¦ [1/5] åŒæ­¥ Homebrew å·¥å…·é“¾..."
brew update
# è¿è¡Œå®‰è£…ï¼Œå¹¶åœ¨å®‰è£…åæ¸…ç†ä¸åœ¨æ¸…å•ä¸­çš„è½¯ä»¶
brew bundle --file={{ joinPath .chezmoi.sourceDir "Brewfile" }} --verbose --cleanup
brew upgrade

echo "ğŸš€ ç”Ÿæˆ Homebrew é™æ€ç¯å¢ƒé…ç½®..."
# æŠŠ brew shellenv çš„è¾“å‡ºé‡å®šå‘åˆ°ä¸€ä¸ªæ–‡ä»¶,.zshrc è¯»å–ç¼“å­˜çš„2ç¯å¢ƒ
/home/linuxbrew/.linuxbrew/bin/brew shellenv zsh > "$HOME/.config/zsh/brew_env.zsh"

echo "ğŸ“¦ [2/5] æ£€æŸ¥/æ›´æ–° Devbox..."
if ! command -v devbox &> /dev/null; then
    curl -fsSL https://get.jetify.com/devbox | bash
else
    devbox version update >/dev/null 2>&1 || true
fi

echo "ğŸ“¦ [3/5] æ£€æŸ¥ Claude Code CLI..."
if ! command -v claude &> /dev/null; then
    curl -fsSL https://claude.ai/install.sh | bash
else
    claude update || true 
fi

echo "ğŸ“¦ [4/5] é…ç½® Podman Socket & Docker Shim..."
mkdir -p "$HOME/.local/bin"

#  Docker Shim (äºŒè¿›åˆ¶åŠ«æŒï¼Œè§£å†³è®¸å¤šå·¥å…·è„šæœ¬ è°ƒç”¨ docker çš„é—®é¢˜)
DOCKER_SHIM="$HOME/.local/bin/docker"
if [ ! -f "$DOCKER_SHIM" ]; then
    cat << 'EOF' > "$DOCKER_SHIM"
#!/bin/sh
exec podman "$@"
EOF
    chmod +x "$DOCKER_SHIM"
    echo "   -> Shim åˆ›å»ºæˆåŠŸ"
fi

#  Systemd Socket (ç”¨æˆ·çº§)
if command -v systemctl &>/dev/null; then
    # ç¡®ä¿ç›®å½•å­˜åœ¨
    mkdir -p "$HOME/.config/systemd/user"
    
    PODMAN_PREFIX=$(brew --prefix podman)
    SOCKET_SRC="$PODMAN_PREFIX/lib/systemd/user/podman.socket"
    SERVICE_SRC="$PODMAN_PREFIX/lib/systemd/user/podman.service"
    
    # é“¾æ¥æœåŠ¡æ–‡ä»¶ (ä½¿ç”¨ -f å¼ºåˆ¶è¦†ç›–é“¾æ¥ï¼Œç¡®ä¿æŒ‡å‘æœ€æ–° brew ç‰ˆæœ¬)
    if [[ -f "$SOCKET_SRC" ]]; then
        ln -sf "$SOCKET_SRC" "$HOME/.config/systemd/user/podman.socket"
        ln -sf "$SERVICE_SRC" "$HOME/.config/systemd/user/podman.service"
        systemctl --user daemon-reload
    fi

    # å¯ç”¨å¹¶ç«‹å³å¯åŠ¨ Socket
    systemctl --user enable --now podman.socket
    
    # æ£€æŸ¥ Socket æ–‡ä»¶
    if [ -S "$XDG_RUNTIME_DIR/podman/podman.sock" ]; then
        echo "âœ… Podman Socket å·²å°±ç»ª: $XDG_RUNTIME_DIR/podman/podman.sock"
    else
        echo "âš ï¸  Podman Socket å¯åŠ¨ä¼¼ä¹å»¶è¿Ÿäº†ï¼Œè¯·ç¨åæ£€æŸ¥ã€‚"
    fi

    # è®¾ç½® Docker Host ä¾›å½“å‰è„šæœ¬åç»­ä½¿ç”¨ (æŒä¹…åŒ–é…ç½®åœ¨ .zshenv)
    export DOCKER_HOST="unix://$XDG_RUNTIME_DIR/podman/podman.sock"
    export TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE="${XDG_RUNTIME_DIR}/podman/podman.sock"
fi

echo "ğŸ“¦ [5/5] é»˜è®¤ Shell è®¾ç½® ..."
TARGET_SHELL="$(which zsh)"
if [ "$SHELL" != "$TARGET_SHELL" ]; then
    # åªè¦è·¯å¾„åœ¨ /etc/shells é‡Œï¼Œchsh å°±èƒ½æˆåŠŸ
    grep -q "$TARGET_SHELL" /etc/shells || echo "$TARGET_SHELL" | sudo tee -a /etc/shells >/dev/null
    sudo chsh -s "$TARGET_SHELL" "$USER"
fi

echo "ğŸ“¦ æå‡æ–‡ä»¶ç›‘å¬ä¸Šé™  ..."
if [ -w /proc/sys/fs/inotify/max_user_watches ]; then
    echo 524288 | sudo tee /proc/sys/fs/inotify/max_user_watches >/dev/null
fi

echo "âœ… ç”¨æˆ·ç¯å¢ƒå°±ç»ªï¼"