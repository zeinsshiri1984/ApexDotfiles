#!/bin/bash
# Brewfile hash: {{ include "Brewfile" | sha256sum }}

set -e # é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢

echo "ğŸ“¦ [1/4] åŒæ­¥ Homebrew å·¥å…·é“¾..."
brew update
# è¿è¡Œå®‰è£…ï¼Œå¹¶åœ¨å®‰è£…åæ¸…ç†ä¸åœ¨æ¸…å•ä¸­çš„è½¯ä»¶
brew bundle --file={{ joinPath .chezmoi.sourceDir "Brewfile" }} --verbose --cleanup
brew upgrade

echo "ğŸš€ ç”Ÿæˆ Homebrew é™æ€ç¯å¢ƒé…ç½®..."
# æŠŠ brew shellenv çš„è¾“å‡ºé‡å®šå‘åˆ°ä¸€ä¸ªæ–‡ä»¶,.zshrc è¯»å–ç¼“å­˜çš„ç¯å¢ƒ
/home/linuxbrew/.linuxbrew/bin/brew shellenv zsh > "$HOME/.config/zsh/brew_env.zsh"

echo "ğŸ“¦ [2/4] æ£€æŸ¥/æ›´æ–° Devbox..."
if ! command -v devbox &> /dev/null; then
    curl -fsSL https://get.jetify.com/devbox | bash
else
    # é™é»˜æ›´æ–°
    devbox version update >/dev/null 2>&1 || true
    echo "   -> Devbox å·²æ˜¯æœ€æ–°"
fi

echo "ğŸ“¦ [3/4] æ£€æŸ¥ Claude Code CLI..."
if ! command -v claude &> /dev/null; then
    curl -fsSL https://claude.ai/install.sh | bash
else
    claude update || true 
    echo "   -> Claude Code å·²å®‰è£…"
fi

echo "ğŸ“¦ [4/4] Podman ç»ˆæä¼ªè£… Shim;æ¯” alias æ›´å¼ºï¼Œèƒ½éª—è¿‡ä»»ä½•è„šæœ¬å’ŒäºŒè¿›åˆ¶ç¨‹åº..."
mkdir -p "$HOME/.local/bin"

# åˆ›å»º Docker -> Podman ä¼ªè£… (å¦‚æœå°šæœªå­˜åœ¨)
# åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢è¦†ç›–ä½ å¯èƒ½æ‰‹åŠ¨ä¿®æ”¹è¿‡çš„ shim
if [ ! -f "$HOME/.local/bin/docker" ]; then
    echo "ğŸ³ åˆ›å»º Docker -> Podman Shim..."
    cat << 'EOF' > "$HOME/.local/bin/docker"
#!/bin/sh
exec podman "$@"
EOF
    chmod +x "$HOME/.local/bin/docker"
fi

# 3. æ³¨å†Œå¹¶å¯åŠ¨ Podman Socket (ä¿®å¤æŠ¥é”™çš„æ ¸å¿ƒ)
if command -v systemctl &>/dev/null; then
    echo "ğŸ”Œ é…ç½® Podman Systemd æœåŠ¡..."
    
    # å®šä¹‰æºæ–‡ä»¶è·¯å¾„ (Homebrew å®‰è£…è·¯å¾„) å’Œ ç›®æ ‡è·¯å¾„ (ç”¨æˆ· Systemd é…ç½®)
    PODMAN_PREFIX=$(brew --prefix podman)
    SYSTEMD_USER_DIR="$HOME/.config/systemd/user"
    mkdir -p "$SYSTEMD_USER_DIR"

    # æ£€æµ‹å¹¶é“¾æ¥æœåŠ¡æ–‡ä»¶
    if [[ -f "$PODMAN_PREFIX/lib/systemd/user/podman.socket" ]]; then
        # å¼ºåˆ¶é“¾æ¥ socket å’Œ service æ–‡ä»¶ï¼Œç¡®ä¿æŒ‡å‘æœ€æ–°ç‰ˆæœ¬
        ln -sf "$PODMAN_PREFIX/lib/systemd/user/podman.socket" "$SYSTEMD_USER_DIR/podman.socket"
        ln -sf "$PODMAN_PREFIX/lib/systemd/user/podman.service" "$SYSTEMD_USER_DIR/podman.service"
        
        # é‡è½½ systemd å®ˆæŠ¤è¿›ç¨‹ä»¥è¯†åˆ«æ–°æ–‡ä»¶
        systemctl --user daemon-reload
        echo "   -> æœåŠ¡æ–‡ä»¶å·²é“¾æ¥å¹¶é‡è½½"
    else
        echo "âš ï¸  è­¦å‘Š: åœ¨ $PODMAN_PREFIX ä¸‹æœªæ‰¾åˆ° Systemd æ–‡ä»¶ï¼Œè·³è¿‡æœåŠ¡æ³¨å†Œã€‚"
    fi

    # å¯ç”¨å¹¶ç«‹å³å¯åŠ¨ Socket
    systemctl --user enable --now podman.socket
    
    # éªŒè¯ Socket æ˜¯å¦è¿™å°±ç»ª
    if [ -S "$XDG_RUNTIME_DIR/podman/podman.sock" ]; then
        echo "âœ… Podman Socket å·²å°±ç»ª: $XDG_RUNTIME_DIR/podman/podman.sock"
    else
        echo "âš ï¸  Podman Socket å¯åŠ¨ä¼¼ä¹å»¶è¿Ÿäº†ï¼Œè¯·ç¨åæ£€æŸ¥ã€‚"
    fi

    # è®¾ç½® Docker Host ä¾›å½“å‰è„šæœ¬åç»­ä½¿ç”¨ (æŒä¹…åŒ–é…ç½®åœ¨ .zshenv)
    export DOCKER_HOST="unix://$XDG_RUNTIME_DIR/podman/podman.sock"
fi

echo "âœ… ç”¨æˆ·ç¯å¢ƒå°±ç»ªï¼"