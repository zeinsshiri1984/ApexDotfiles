# ---  Powerlevel10k Instant Prompt (必须在最前面) ---
# 这一步会创建缓存，让 Prompt 在插件加载完之前就显示出来
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# 非交互式 shell 直接退出
[[ $- != *i* ]] && return

source "$ZDOTDIR/options.zsh"

# Homebrew 静态加载
# 如果缓存文件存在，直接 source
if [[ -f "$ZDOTDIR/brew_env.zsh" ]]; then
    source "$ZDOTDIR/brew_env.zsh"
else
    # 兜底：如果缓存文件丢了，回退到慢速的官方 eval 方法，并后台重新生成缓存
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    (/home/linuxbrew/.linuxbrew/bin/brew shellenv zsh > "$ZDOTDIR/brew_env.zsh" &)
fi

# Antidote Plugins (Static Loading)
# 首次运行时生成 static_plugins.zsh，之后直接 source 静态文件
zsh_plugins=${ZDOTDIR:-~/.config/zsh}/.zsh_plugins.txt
zsh_static=${ZDOTDIR:-~/.config/zsh}/zsh_static.zsh
# 仅在插件列表更新时重新生成静态文件
if [[ ! -f "$zsh_static" ]] || [[ "$zsh_plugins" -nt "$zsh_static" ]]; then
    source "$(brew --prefix antidote)/share/antidote/antidote.zsh"
    antidote bundle < "$zsh_plugins" > "$zsh_static"
    zcompile "$zsh_static" # 编译加速读取
fi
source "$zsh_static"

# Load Modules
source "$ZDOTDIR/tools.zsh"       # 里面有 zsh-defer，优先加载
source "$ZDOTDIR/plugins.zsh"
source "$ZDOTDIR/aliases.zsh"
source "$ZDOTDIR/functions.zsh"
source "$ZDOTDIR/keybindings.zsh"
source "$ZDOTDIR/maintain.zsh"
# ---  加载 P10k 配置 (优先加载以显示界面) ---
source "$ZDOTDIR/p10k.zsh"

export GPG_TTY=$(tty) # 确保 GPG TTY 正确，否则 git 签名会报错
unset MANPATH # 确保终端控制码重置,避免某些系统上的 manpath 混乱