set shell := ["bash", "-eu", "-o", "pipefail", "-c"]

default:
    @just --list

host:
    @just nala
    @just mihomo
    @just podman

# 系统包与镜像维护
nala:
    @echo "正在重新测试并优化最快镜像源..."
    sudo nala fetch --auto --https-only -y
    @echo "同步软件包索引..."
    sudo nala update
    @echo "执行系统升级..."
    sudo nala upgrade -y
    @echo "清理冗余依赖..."
    sudo nala autoremove -y
    sudo nala autopurge -y
    @echo "修复潜在依赖损坏..."
    sudo apt --fix-broken install

mihomo:
    @echo "mihomo 内核升级..."
    curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest \
      | grep browser_download_url \
      | grep linux-amd64 \
      | grep -v compatible \
      | grep '.gz"' \
      | head -n 1 \
      | cut -d '"' -f 4 \
      | xargs -n1 curl -L -o /tmp/mihomo.gz
    gunzip -f /tmp/mihomo.gz
    chmod +x /tmp/mihomo
    sudo mv -f /tmp/mihomo /usr/local/bin/mihomo

    @echo "升级 UI 面板..."
    curl -s https://api.github.com/repos/MetaCubeX/metacubexd/releases/latest \
      | grep browser_download_url \
      | grep compressed-dist.tgz \
      | head -n 1 \
      | cut -d '"' -f 4 \
      | xargs -n1 curl -L -o /tmp/metacubexd.tgz
    sudo rm -rf /etc/mihomo/ui/*
    sudo tar -xzf /tmp/metacubexd.tgz -C /etc/mihomo/ui
    rm -f /tmp/metacubexd.tgz

    @echo "重启 Mihomo 服务以应用升级..."
    sudo systemctl restart mihomo

    @just mihomo-tips

mihomo-tips:
    @LOCAL_IP=$(hostname -I | awk '{print $1}'); \
    echo "在浏览器打开 WebUI 管理：http://$LOCAL_IP:9090/ui"; \
    echo "Mihomo 服务管理（原生命令）："; \
    echo "  启动:   sudo systemctl start mihomo"; \
    echo "  停止:   sudo systemctl stop mihomo"; \
    echo "  重启:   sudo systemctl restart mihomo"; \
    echo "  状态:   systemctl status mihomo"; \
    echo "  日志查看: journalctl -u mihomo -f"

podman:
    @just podman-tips
    @just podman-images
    @just podman-clean

podman-tips:
    @echo "Podman 版本与运行模式:"
    podman --version
    podman info --debug | sed -n '1,120p'

    @echo "验证代理环境（containers.conf）:"
    podman info --debug | grep -i proxy || true

    @echo "  查看镜像:        podman images"
    @echo "  查看容器:        podman ps -a"
    @echo "  拉取镜像:        podman pull alpine"
    @echo "  运行容器:        podman run --rm -it alpine sh"
    @echo "  停止容器:        podman stop <container>"
    @echo "  删除容器:        podman rm <container>"
    @echo "  查看日志:        podman logs <container>"
    @echo "  查看信息:        podman info"
    @echo "  Docker 兼容层:   docker ps"

podman-images:
    @echo "列出本地镜像:"
    podman images

    @echo "  拉取镜像:        podman pull <image>"
    @echo "  删除镜像:        podman rmi <image>"
    @echo "  查看容器:        podman ps -a"
    @echo "  运行容器:        podman run --rm -it <image> sh"
    @echo "  停止容器:        podman stop <container>"
    @echo "  删除容器:        podman rm <container>"
    @echo "  查看日志:        podman logs <container>"
    @echo "  查看信息:        podman info"

podman-clean:
    @echo "清理停止的容器与悬空镜像（安全）..."
    podman container prune -f
    podman image prune -f