# Non-interactive? Exit.
[[ $- != *i* ]] && return

# 1. Mise Activation (Essential)
# 必须先激活 Mise，才能找到 config.toml 中定义的 Nushell
if [ -x "$HOME/.local/bin/mise" ]; then
  eval "$($HOME/.local/bin/mise activate bash)"
fi

# 2. The Handover to Nushell (Interactive Only)
# 只有在没有进入 Nu 子 shell 时才执行
if command -v nu &> /dev/null && [ -z "${NU_VERSION-}" ]; then
    
    # [Pre-Flight] Ensure Podman Socket (Standard Linux/WSL)
    # 快速检查，避免每次启动都调用 systemctl
    if [ ! -S "$XDG_RUNTIME_DIR/podman/podman.sock" ]; then
        if command -v systemctl &> /dev/null; then
            systemctl --user start podman.socket &> /dev/null || true
        fi
    fi

    # [EXEC] Replace Bash Process
    # 使用 exec 节省内存并保持 PID
    exec nu
fi

# 3. Bash Fallback (Rescue Mode)
# 如果 Nushell 挂了，这里是最后的防线
[ -f ~/.profile ] && . ~/.profile

if command -v starship >/dev/null 2>&1; then
    eval "$(starship init bash)"
fi
alias ls='ls --color=auto'
alias ll='ls -alF'