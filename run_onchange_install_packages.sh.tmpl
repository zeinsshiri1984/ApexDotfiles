#!/bin/bash

# gitä»“åº“åŒæ­¥æ¸…å•å,chezmoi appæ£€æµ‹æ¸…å•æ–‡ä»¶å“ˆå¸Œæ”¹å˜,è§¦å‘run_onchange
# mise.toml hash: {{ include "dot_config/mise/config.toml.tmpl" | sha256sum }}
# devbox.json hash: {{ include "dot_config/devbox/global.json" | sha256sum }}

set -euo pipefail

echo "ğŸ”„ Detected configuration change. Updating packages..."

# ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨è„šæœ¬ä¸­ç”Ÿæ•ˆ
export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"

# Mise (Static Binaries)
if command -v mise &> /dev/null; then
    echo "ğŸ“¦ Mise: Installing tools..."
    mise install -y -q
    mise prune -y # æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œä¿æŒç£ç›˜æ¸…æ´
else
    echo "âš ï¸ Mise not found. Skipping."
fi

# Devbox sync
if command -v devbox &> /dev/null; then
    echo "ğŸ“¦ Devbox: Updating global packages..."
    # æ£€æŸ¥ PATH ä¸­æ˜¯å¦åŒ…å« .devbox ç›®å½•ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆå§‹åŒ–
    if [[ ":$PATH:" != *".devbox/virtenv/global"* ]]; then
        eval "$(devbox global shellenv)"
    fi
else
    echo "âš ï¸ Devbox not found. Skipping."
fi

echo "âœ… Package synchronization complete."
