#!/bin/bash

# git‰ªìÂ∫ìÂêåÊ≠•Ê∏ÖÂçïÂêé,chezmoi appÊ£ÄÊµãÊ∏ÖÂçïÊñá‰ª∂ÂìàÂ∏åÊîπÂèò,Ëß¶Âèërun_onchange
# mise.toml hash: {{ include "dot_config/mise/config.toml" | sha256sum }}
# devbox.json hash: {{ include "dot_config/devbox/global.json" | sha256sum }}

set -euo pipefail

echo "üîÑ Detected configuration change. Updating packages..."

# Mise (Static Binaries)
if command -v mise &> /dev/null; then
    echo "üì¶ Mise: Installing tools..."
    mise install -y -q
    # Ê∏ÖÁêÜÊóßÁâàÊú¨Ôºå‰øùÊåÅÁ£ÅÁõòÊ∏ÖÊ¥Å
    mise prune -y
else
    echo "‚ö†Ô∏è Mise not found. Skipping."
fi

# Devbox (System Libs)
if command -v devbox &> /dev/null; then
    echo "üì¶ Devbox: Updating global packages..."
    # Á°Æ‰øù devbox ÂÖ®Â±ÄÈÖçÁΩÆÁõÆÂΩïÂ≠òÂú®
    mkdir -p "$HOME/.local/share/devbox/global"
    
    # Âº∫Âà∂ÊãâÂèñÊõ¥Êñ∞
    devbox global pull
    
    # Immutable OS ‰∏äÁöÑÁâπÊÆäÂ§ÑÁêÜ (Â¶ÇÊûúÈúÄË¶ÅÊ∏ÖÁêÜÊàñÈáçÂª∫ symlinks)
    devbox global shellenv --init-hook > /dev/null
else
    echo "‚ö†Ô∏è Devbox not found. Skipping."2
fi

echo "‚úÖ Package synchronization complete."