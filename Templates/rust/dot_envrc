# æ¿€æ´» Devbox ç¯å¢ƒ
use devbox

# Sops è‡ªåŠ¨è§£å¯†:éå†æ‰€æœ‰ .secret.env åç¼€çš„æ–‡ä»¶
for secret_file in *.secret.env; do
    # å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼ˆå¤„ç†é€šé…ç¬¦ä¸åŒ¹é…çš„æƒ…å†µï¼‰
    if [ -f "$secret_file" ]; then
        # è®¡ç®— Hash ç”¨äºç¼“å­˜å‘½å
        secret_hash=$(sha256sum "$secret_file" | cut -d ' ' -f 1)
        # å­˜æ”¾åœ¨ XDG_RUNTIME_DIR (å†…å­˜ç›˜ /run/user/1000)ï¼Œé‡å¯å³ç„šï¼Œæ¯”ç¡¬ç›˜å®‰å…¨
        cache_dir="$XDG_RUNTIME_DIR/devbox-secrets/$PWD_HASH"
        mkdir -p "$cache_dir"
        cache_file="$cache_dir/.decrypted-${secret_hash}.env"

        # å¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œæˆ–è€…æºæ–‡ä»¶æ¯”ç¼“å­˜æ–°ï¼Œåˆ™é‡æ–°è§£å¯†
        if [ ! -f "$cache_file" ] || [ "$secret_file" -nt "$cache_file" ]; then
            echo "ğŸ”“ Decrypting $secret_file to Memory FS..."
            # æå–å¯†é’¥æ³¨å…¥ç¯å¢ƒå˜é‡ --format dotenv å‘Šè¯‰ sops è¿™æ˜¯ä¸€ä¸ª key=value æ ¼å¼çš„æ–‡ä»¶
            sops -d --format dotenv "$secret_file" > "$cache_file"
            chmod 600 "$cache_file"
        fi

        # åŠ è½½è§£å¯†åçš„å˜é‡
        source "$cache_file"
    fi
done